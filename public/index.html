<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ü™ªDaijoubu's Private Island Queueü™ª</title>
<link href="https://fonts.googleapis.com/css2?family=Linotte:wght@600&display=swap" rel="stylesheet">
<style>
* { font-family: 'Linotte', sans-serif !important; font-weight: bold !important; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
body { margin:0; padding:0; text-align:center; background:url('bg.jpg') no-repeat center center fixed; background-size:cover; }
.card{ background: rgba(255,255,255,0.9); width:360px; margin:40px auto; padding:25px; border-radius:25px; box-shadow:0 10px 25px rgba(0,0,0,0.2);}
input{ padding:10px; margin:8px 0; border-radius:10px; border:1px solid #ccc; width:85%; }
button{ background:#ffb6b9; border:none; padding:10px 18px; border-radius:12px; cursor:pointer;}
button:hover{background:#ff8b94;}
header{ width:100%; padding:15px; background: rgba(255,255,255,0.9); display:flex; justify-content:space-between; align-items:center;}
.progress-container{ background: #ddd; border-radius: 20px; height: 20px; overflow: hidden; margin-top: 10px;}
.progress-bar{ height: 100%; width: 0%; background: green; transition: 0.3s;}
.comment-box{ text-align:left; max-height:200px; overflow-y:auto; margin-bottom:10px;}
.comment-item{ background:#f5f5f5; padding:8px; border-radius:10px; margin-bottom:8px;}
#rulesModal, #aboutModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); z-index:9999;}
#rulesModal div, #aboutModal div{ background:#fff; padding:30px; border-radius:20px; margin:100px auto; width:90%; max-width:400px; box-shadow:0 10px 20px rgba(0,0,0,0.3);}
#rulesModal button, #aboutModal button{ border:none; padding:12px 20px; border-radius:12px; background:#ffb6b9; cursor:pointer; transition:0.2s;}
#rulesModal button:hover, #aboutModal button:hover{background:#ff8b94;}
#rulesModal a, #aboutModal a{color:#ff8b94; font-weight:bold; text-decoration:none;}
#rulesModal a:hover, #aboutModal a:hover{text-decoration:underline;}
footer{ width:100%; background:#ffd700; padding:12px 0; display:flex; justify-content:center; gap:20px; box-shadow:0 -4px 10px rgba(0,0,0,0.2); position:fixed; bottom:0;}
footer a{ display:flex; align-items:center; gap:8px; text-decoration:none; color:#000; background:#fff; padding:8px 12px; border-radius:12px; transition:0.2s;}
footer a:hover{background:#ffeb99;}
footer img{width:24px; height:24px;}
.toast{position:fixed; top:20px; right:20px; background:#4CAF50; color:#fff; padding:12px 20px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.3); z-index:10000; animation:fadeinout 3s forwards;}
@keyframes fadeinout{0%{opacity:0; transform:translateY(-20px);}10%{opacity:1; transform:translateY(0);}90%{opacity:1;}100%{opacity:0; transform:translateY(-20px);}}
</style>
</head>
<body>

<header>
  <h1>üå∏Private Island Queueüå∏</h1>
  <button onclick="openRules()">‚ÑπÔ∏è Island Rules</button>
</header>

<!-- Rules Modal -->
<div id="rulesModal">
  <div>
    <h2>üå¥ Welcome to My Private Island</h2>
    <ul style="text-align:left; margin:15px 0;">
      <li>Grab anything you need!</li>
      <li>Leave via AIRPORT Only</li>
      <li>Follow the queue order</li>
      <li>Click Leave Island once you leave my island!</li>
      <li>Check out my <a href="https://discord.gg/YXfmSWuKQT" target="_blank">üí¨ Discord</a></li>
      <li>Private Treasure Islands on <a href="https://ko-fi.com/daijoubuxix/tiers" target="_blank">‚òï Ko-fi</a>!</li>
    </ul>
    <button onclick="closeRules()">I Understand</button>
  </div>
</div>

<!-- Login Card -->
<div class="card" id="login">
  <h2>üå¥ Island Queue</h2>
  <input id="username" placeholder="Player Name"><br>
  <input id="visitorIsland" placeholder="Island Name"><br>
  <input id="visitorPassword" placeholder="Your Password" type="password"><br>
  <button onclick="login()">Join Island Queue</button>
  <p style="margin-top:15px;" id="visitorCountDisplay">Visitors on island: 0/7</p>
</div>

<!-- Queue Card -->
<div class="card" id="queue" style="display:none;">
  <h2 id="status"></h2>
  <p id="position"></p>
  <div class="progress-container">
    <div id="progressBar" class="progress-bar"></div>
  </div>
  <p id="progressText">0/7 Visitors</p>
  <h3 id="code"></h3>
  <button id="copyBtn">üìã Copy Dodo Code</button><br>
  <button id="leaveBtn">Leave Island</button>
</div>

<!-- Guestbook -->
<div class="card" id="guestbook" style="display:none; max-height:300px; overflow-y:auto;">
  <h2>üå∏ Visitor Guestbook</h2>
  <div id="commentsList" class="comment-box"></div>
  <input id="commentText" placeholder="Leave a comment..." style="width:80%;">
  <button onclick="submitComment()">Post</button>
</div>

<!-- Treasure Maps -->
<div class="card" id="mapsSection" style="display:none;">
  <h2>üó∫Ô∏è Treasure Island Maps</h2>
  <p><a id="mapsLink" href="https://imgur.com/a/maps-BVMEz0p" target="_blank" style="font-weight:bold; color:#ff8b94;">üå¥ View My Treasure Island Maps</a></p>
</div>

<!-- Turnip Prices -->
<div class="card" id="turnipCard" style="display:none;">
  <h2>üí∞ Turnip Prices</h2>
  <img id="turnipLogo" src="turnip.png" alt="Turnip Logo" style="width:60px;height:60px;"><br>
  <p id="turnipPrice">Loading price...</p>
  <button id="updateTurnipBtn" style="display:none;">Update Price</button>
</div>

<footer>
  <a href="https://ko-fi.com/daijoubuxix/tiers" target="_blank"><img src="kofi-logo.png" alt="Ko-fi Logo">‚òï Private Treasure Islands</a>
  <a href="https://discord.gg/YXfmSWuKQT" target="_blank"><img src="discord-logo.png" alt="Discord Logo">üí¨ Join my Community</a>
</footer>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let userId = localStorage.getItem("queueUserId");

// --- Rules modal ---
function openRules(){document.getElementById("rulesModal").style.display="block";}
function closeRules(){document.getElementById("rulesModal").style.display="none"; localStorage.setItem("rulesSeen","true");}

// --- Queue UI ---
function showQueueUI(){
  document.getElementById("login").style.display="none";
  document.getElementById("queue").style.display="block";
  document.getElementById("mapsSection").style.display="block";
  document.getElementById("guestbook").style.display="block";
  document.getElementById("turnipCard").style.display="block";
}

// --- Login ---
function login(){
  const username = document.getElementById("username").value.trim();
  const visitorIsland = document.getElementById("visitorIsland").value.trim();
  const visitorPassword = document.getElementById("visitorPassword").value.trim();
  if(!username || !visitorIsland || !visitorPassword){alert("Fill all fields"); return;}

  fetch("/login",{method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username,visitorIsland,visitorPassword})})
    .then(res=>res.json())
    .then(data=>{
      if(data.success){
        userId = crypto.randomUUID();
        localStorage.setItem("queueUserId",userId);
        showQueueUI();
        socket.emit("joinQueue",{userId,username,visitorIsland,visitorPassword});
      } else alert("Incorrect credentials");
    });
}

// --- Queue updates ---
socket.on("queueUpdate",(data)=>{
  const user = data.users.find(u=>u.userId===userId);
  if(!user) return;
  document.getElementById("position").innerText="Position: "+user.position;

  const percent = (data.activeCount/7)*100;
  const bar = document.getElementById("progressBar");
  bar.style.width = percent+"%";
  bar.style.background = data.activeCount>=7?"red":"green";
  document.getElementById("progressText").innerText=data.activeCount+"/7 Visitors";

  if(user.active){
    document.getElementById("status").innerText="üéâ You're on the island!";
    document.getElementById("code").innerText="Dodo Code: "+user.dodoCodeDisplay;
  } else {
    document.getElementById("status").innerText="üåº Waiting in queue...";
    document.getElementById("code").innerText=user.dodoCodeDisplay;
  }

  // --- Reminder after 10 min ---
  if(user.active){
    if(!user.reminderSent){
      setTimeout(()=>{
        alert("‚è∞ Reminder: Please click 'Leave Island' if you have finished, so others can join.");
        user.reminderSent = true;
      },10*60*1000);
    }
  }
});

// --- Copy Dodo code ---
document.getElementById("copyBtn").onclick=()=>{
  const code = document.getElementById("code").innerText.replace("Dodo Code: ","");
  if(code) navigator.clipboard.writeText(code).then(()=>alert("Copied: "+code));
};

// --- Leave Island ---
document.getElementById("leaveBtn").onclick=()=>{
  socket.emit("leaveIsland",userId);
  localStorage.removeItem("queueUserId");
  location.reload();
};

// --- Guestbook ---
function submitComment(){
  const comment = document.getElementById("commentText").value.trim();
  if(!comment) return alert("Write something!");
  const username = document.getElementById("username").value.trim();
  const island = document.getElementById("visitorIsland").value.trim();
  socket.emit("newComment",{userId,username,island,comment});
  document.getElementById("commentText").value="";
}
socket.on("updateComments",(comments)=>{
  const box = document.getElementById("commentsList");
  box.innerHTML="";
  comments.forEach(c=>{
    box.innerHTML+=`<div class="comment-item"><strong>${c.username}</strong> (${c.island})<br>${c.comment}</div>`;
  });
});

// --- Turnip Prices ---
const turnipPriceEl = document.getElementById("turnipPrice");
const updateBtn = document.getElementById("updateTurnipBtn");
socket.on("turnipPriceUpdate",(price)=>{ turnipPriceEl.innerText = `Today's price: ${price} Bells`; });
updateBtn.onclick = ()=>{
  const price = prompt("Enter today's turnip price:");
  if(price) socket.emit("updateTurnipPrice",price,"admin123");
};
</script>
</body>
</html>