<div class="card">
<h2>ðŸŒ´ Control Panel</h2>

<!-- Dodo & Password Management -->
<input id="dodoInput" placeholder="Enter new Dodo Code">
<button onclick="updateDodo()">Update Dodo Code</button><br>

<input id="islandPasswordInput" placeholder="Set Island Password">
<button onclick="updateIslandPassword()">Update Island Password</button><br>

<!-- Turnip Price Management -->
<input id="turnipInput" placeholder="Today's Turnip Price">
<button onclick="updateTurnipPrice()">Update Turnip Price</button><br>

<!-- Live Visitor Status -->
<h3>Visitor Status</h3>
<p>Currently on Island: <span id="visitorCount">0</span>/7</p>
<table>
<thead>
<tr>
<th>Player Name</th>
<th>Island Name</th>
<th>Password</th>
<th>Position</th>
<th>Status</th>
<th>Joined At</th>
<th>Time on Island</th>
</tr>
</thead>
<tbody id="visitorTable"></tbody>
</table>
</div>

<script>
const socket = io();
let islandPassword = "daijoubu";

function showToast(msg){
    const toast = document.createElement("div");
    toast.className="toast"; toast.innerText = msg;
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(),3000);
}

// Dodo code update
function updateDodo(){
    const code = document.getElementById("dodoInput").value.trim();
    if(code){
        socket.emit("updateDodo", code);
        showToast("âœ… Dodo code updated!");
    }
}

// Island password update
function updateIslandPassword(){
    const newPass = document.getElementById("islandPasswordInput").value.trim();
    if(newPass){
        islandPassword = newPass;
        socket.emit("updateIslandPassword", newPass);
        showToast("âœ… Island password updated!");
    }
}

// Turnip price update
function updateTurnipPrice(){
    const price = document.getElementById("turnipInput").value.trim();
    if(price){
        socket.emit("updateTurnipPrice", price);
        showToast("âœ… Turnip price updated!");
    }
}

let joinTimes = {};
let visitorData = [];

function renderTable(){
    const tbody = document.getElementById("visitorTable");
    tbody.innerHTML = "";
    visitorData.forEach(u=>{
        const joinedAt = joinTimes[u.userId] || new Date();
        let timeOnIsland = "-";
        if(u.active){
            const diffMs = new Date() - joinedAt;
            const diffMins = Math.floor(diffMs/60000);
            const diffSecs = Math.floor((diffMs%60000)/1000);
            timeOnIsland = `${diffMins}m ${diffSecs}s`;
        }
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${u.username}</td>
                        <td>${u.visitorIsland}</td>
                        <td>${u.visitorPassword}</td>
                        <td>${u.position}</td>
                        <td>${u.active ? 'On Island' : 'Waiting'}</td>
                        <td>${joinedAt.toLocaleString()}</td>
                        <td>${timeOnIsland}</td>`;
        tbody.appendChild(tr);
    });
    document.getElementById("visitorCount").innerText = visitorData.filter(v=>v.active).length;
}

socket.on("queueUpdate", data => {
    visitorData = data.users;
    visitorData.forEach(u=>{
        if(!joinTimes[u.userId]) joinTimes[u.userId] = new Date();
    });
    renderTable();
});

setInterval(()=>{ if(visitorData.length>0) renderTable(); },1000);
</script>